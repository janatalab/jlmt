% script to package up jlmt files for distribution
% 
% FB 2012.05.21 - adapted from private/matlab/projects/rhythm_profiler/dist/rp_package_dist.m

[~,user] = unix('whoami');
user = regexprep(user,'\s','');

if isempty(which('btb'))
  path(path,genpath(sprintf('/home/%s/svn/private/matlab/projects/rhythm_profiler',user)));
end
if isempty(which('listFilesOfType'))
  path(path,genpath(sprintf('/home/%s/svn/private/matlab/projects/tonmodcomp',user)));
end

vnum = 1.2; % version number

GENERATE_DOCUMENTATION = 1;
EDIT_FILES = 0;
DISTRIBUTE_TO_ATONAL = 0;

home_path = fullfile('/home',user);
priv_path = fullfile(home_path,'svn','private','matlab');
pub_path = fullfile(home_path,'svn','public','matlab');

relative_dist_path = sprintf('jlmt_v%1.1f/',vnum);
dist_path = fullfile(home_path,relative_dist_path);
www_path = '/var/www/html/resources/software/';
dist_file = sprintf('jlmt_v%1.1f.tar.gz',vnum);
log_file = fullfile(home_path,'data','jlmt_files.log');
readme_file = fullfile(priv_path,'jlmt','dist','README.txt');
install_file = fullfile(priv_path,'jlmt','dist','INSTALL.txt');
release_notes_file = fullfile(priv_path,'jlmt','dist','RELEASE_NOTES.txt');

colormap_list = {fullfile(pub_path,'colormaps','new_seismic')};

data_list = {...
    fullfile(priv_path,'jlmt','maps','map_10-Dec-2006_16:18.mat'),...
    fullfile(priv_path,'jlmt','maps','pc_ci2toract_map_12-Jun-2012_15:47.mat'),...
    fullfile(priv_path,'jlmt','maps','pp2pitchclass_W_20121105.mat'),...
    '/nfs/stimuli/audio/tension/Bach1_midi_75bpm_03112011.wav',...
    '/nfs/stimuli/audio/tension/Bach2_midi_75bpm_03112011.wav',...
    '/nfs/stimuli/audio/groove/polystream_move/funk1_strong.mp3',...
    '/nfs/stimuli/audio/groove/polystream_move/funk2_strong.mp3',...
    '/usr/local/bin/mpg123',...
    '/usr/local/bin/mp3info',...
    };
%     '/data2/tonmodcomp/bigand_etal_jep_2003/B_I_NTC/audio/B_I_NTC.wav',...
%     '/data2/tonmodcomp/bigand_etal_jep_2003/B_IV_NTC/audio/B_IV_NTC.wav',...
%     '/data2/tonmodcomp/marmel_and_tillmann_mp_2009/Riii0/audio/Riii0.mp3',...
%     '/data2/tonmodcomp/marmel_and_tillmann_mp_2009/Rvii0/audio/Rvii0.mp3',...
%     '/data2/tonmodcomp/marmel_etal_jep_2010/piano1MiF/audio/piano1MiF.wav',...
%     '/data2/tonmodcomp/marmel_etal_jep_2010/piano2BivF/audio/piano2BivF.wav',...
%     '/data2/tonmodcomp/marmel_etal_jep_2010/pure1AiF/audio/pure1AiF.wav',...
%     '/data2/tonmodcomp/marmel_etal_jep_2010/pure2AivF/audio/pure2AivF.wav',...
%     '/data2/tonmodcomp/marmel_etal_pp_2008/Gi/audio/Gi.wav',...
%     '/data2/tonmodcomp/marmel_etal_pp_2008/Giv/audio/Giv.wav',...
%     '/data2/tonmodcomp/tillmann_etal_cbr_2003/1RCinBB/audio/1RCinBB.wav',...
%     '/data2/tonmodcomp/tillmann_etal_cbr_2003/1RCinCB/audio/1RCinCB.wav',...
%     '/data2/tonmodcomp/tillmann_etal_cbr_2003/3UCinBB/audio/3UCinBB.wav',...
%     '/data2/tonmodcomp/tillmann_etal_cbr_2003/3UCinCB/audio/3UCinCB.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2003/C_I_baseline_cons/audio/C_I_baseline_cons.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2003/C_I_cons/audio/C_I_cons.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2003/C_IV_baseline_cons/audio/C_IV_baseline_cons.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2003/C_IV_cons/audio/C_IV_cons.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2008/CD/audio/CD.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2008/CDb/audio/CDb.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2008/CS/audio/CS.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2008/CSb/audio/CSb.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2008/CT/audio/CT.wav',...
%     '/data2/tonmodcomp/tillmann_etal_jep_2008/CTb/audio/CTb.wav',...
%     '/data2/tonmodcomp/closure_work/closure_final/closure_struct_empr.mat',...
%     '/data2/tonmodcomp/closure_work/closure_final/closure_struct_hypo.mat',...
%     '/data2/tonmodcomp/closure_work/closure_final/closure_struct_smth.mat',...
    
%     '/data2/modulation/modpitchclass/pp2pitchclass_nnet_full_20120611T113342.mat',...

file_list = {
    'ani_paramGroups',...
    'approx_peak_ratios',...
    'bessel_i0',...
    'calc_ani',...
    'calc_pp',...
    'calc_pc',...
    'calc_li',...
    'calc_ci',...
    'calc_toract',...
    'calc_tonreg_fmri',...
    'calc_rp',...
    'cell2str',...
    'check_anal_exist',...
    'check_dir',...
    'check_stim_dirs',...
    'coherence',...
    'compare_cells',...
    'compare_structs',...
    'construct_analfname',...
    'create_jlmt_tmpdir',...
    'delete_duplicate_jlmtCalc',...
    'ensemble_init_data_struct',... 
    'ensemble_tree2datastruct',...
    'ensemble_datastruct2tree',...
    'ensemble_merge_data',...
    'find_peaks',...
    'get_axhandle',...
    'get_resonPeakInfo',...
    'get_rp_peakWidths',...
    'get_rpPlotInfo',...
    'init_aud',...
    'init_midi',...
    'init_ani_struct',...
    'init_li_struct',...
    'init_pp_struct',...
    'init_rp_struct',...
    'invert_sig',...
    'jlCorr',...
    'jlKLdist',...
    'jlPost_target_mean',...
    'jlmt_preproc_params.m',...
    'jlmt_proc_series',...
    'jlmt_startup',...
    'javamidi2tr',...
    'listFilesOfType',...
    'Midi2tr.java',...
    'map_max',...
    'mkstruct',...
    'mp3read_jlmt',...
    'new_aud',...
    'nmat2aud',...
    'nmat_columns',...
    'params_ani',...
    'params_aud',...
    'params_ci',...
    'params_li',...
    'params_pc',...
    'params_pp',...
    'params_toract',...
    'params_tonreg_fmri',...
    'parse_fh',...
    'peak_areas',...
    'peak_heights',...
    'peak_widths',...
    'plot_dir_rhythm_profile',...
    'plot_findPeaks',...
    'plot_peakRatios',...
    'plot_rhythmProfile',...
    'plot_rpBandSigs',...
    'plot_rpInput',...
    'plot_rpMeanResonEnergy',...
    'plot_rpResonEnergy',...
    'plot_rpResonOutput',...
    'pp_atten_func',...
    'resonatorBanks',...
    'resonatorEnergy',...
    'rotateyticklabel',...
    'rp_complexExpectAtOnsets',...
    'rp_figure',...
    'rp_mppByFrame',...
    'rp_onsetInfo',...
    'rp_paramGroups_v2',...
    'rp_vonMisesExpectCalc',...
    'set_var_col_const',...
    'sigEntropy',...
    'struct_union',...
    'target_relative_readout',...
    'test_btb',...
    'test_jlmt',...
    'toroidal_spect',...
    'TrackInfo.java',...
    'von_mises_pdf.m',...
    };
%     'CollinsEtAl_analysis',...
%     'CollinsEtAl_calc_attributes',...
%     'CollinsEtAl_closure_event_corr_mean',...
%     'CollinsEtAl_closure_probability',...
%     'CollinsEtAl_datasets',...
%     'CollinsEtAl_globals',...

%     'metric_readout',...
%     'build_path_list',...

pathRep = {fullfile(pub_path,'database'),'utils';...
	   fullfile(pub_path,'utils'),'utils';...
       fullfile(pub_path,'database'),'utils';...
       fullfile(priv_path,'analysis/tonality/metrics'),'utils';...
	   fullfile(priv_path,'data_types/event_objects'),'event_objects';...
       fullfile(priv_path,'database_private'),'utils';...
	   fullfile(priv_path,'jlmt/rp_modules'),'proc/rp_modules';...
       fullfile(priv_path,'jlmt/test'),'test';...
       fullfile(priv_path,'jlmt/jlmt_startup.m'),'jlmt_startup.m';...
       fullfile(priv_path,'jlmt/includes/mp3read_jlmt.m'),'utils/mp3read.m';...
	   fullfile(priv_path,'jlmt'),'proc';...
	   fullfile(priv_path,'projects/rhythm_profiler/params'),'proc/params';...
	   fullfile(priv_path,'projects/rhythm_profiler'),'.';...
       fullfile(priv_path,'projects/tonmodcomp'),'utils';...
	   fullfile(priv_path,'utils/converters'),'utils';...
	   fullfile(priv_path,'utils/signal'),'utils';...
	   fullfile(priv_path,'utils/stats'),'utils';...
	   '/home/matrpcuser/svn/thirdparty/matlab/miditoolbox','midi';...
       '/home/matrpcuser/svn/thirdparty/matlab/stats','utils';...
       '/data2/tontraj/orig_maps','data/maps';...
       '/data2/modulation/cont_popout','data/maps';...
       '/data2/tonmodcomp/modorig/som','data/maps';...
       '/data2/modulation/modpitchclass','data/maps';...
       '/data2/tonmodcomp/closure_work/closure_final','data/closure';...
       '/data2/tonmodcomp','data';...
       '/nfs/stimuli/audio/tension','data/test_jlmt';...
       '/nfs/stimuli/audio/groove/polystream_move','data/test_jlmt';...
       '/usr/local/bin','utils';...
        fullfile(priv_path,'jlmt'),'';...
        ...%'audio','';...
       };

if(exist(dist_path,'dir'))
  eval(['!rm -r ' dist_path]);
end

check_dir(dist_path,1);
fid = fopen(log_file,'w');

nfiles = length(file_list);
for ifile = 1:nfiles
  filesource_list{ifile} = which(file_list{ifile});
  fprintf(fid,'%s\n',filesource_list{ifile});
end

if(EDIT_FILES)
  eval(['!emacs ' cell2str(filesource_list,' ') ' &']);
else
  % add data files (you wouldn't want to try to edit *wav files in emacs)
  filesource_list = [filesource_list data_list];
  nfiles = length(filesource_list);

  %go ahead and package for distribution if not editing files.
  filedest_list = filesource_list;
  for iPath = 1:size(pathRep,1)
    filedest_list = strrep(filedest_list,pathRep{iPath,1},pathRep{iPath,2});  
  end
  filedest_list = strcat(dist_path,filedest_list);
  
  for ifile = 1:nfiles
    [pth,f,e] = fileparts(filedest_list{ifile});
    if(~exist(pth,'dir'))
      mkdir(pth);
    end
    copy_string = ['!cp ' filesource_list{ifile} ' ' filedest_list{ifile}];
    fprintf(1,'%s\n',copy_string);
    eval(copy_string);
  end
  
  %create documentation
  if(GENERATE_DOCUMENTATION)
    cd(home_path);
    m2html('mfiles',relative_dist_path,'htmldir',fullfile(home_path,'documentation'),'recursive','on');
    eval(['!mv ' fullfile(home_path,'documentation') ' '  relative_dist_path]);
    %deleting old documentation
    if(DISTRIBUTE_TO_ATONAL)
      eval(['!ssh chromatic.cmb.ucdavis.edu rm -r ' fullfile(www_path,'documentation')]);
      eval(['!scp -r ' fullfile(relative_dist_path,'documentation') ' chromatic.cmb.ucdavis.edu:' www_path]);
    end
  end
  
  %copy the readme, install, and release notes files
  fprintf(1,'copying readme, install, and release notes files\n');
  eval(['!cp ' readme_file ' ' dist_path]);
  eval(['!cp ' install_file ' ' dist_path]);
  eval(['!cp ' release_notes_file ' ' dist_path]);

  %copy colormaps
  fprintf(1,'copying colormaps\n');
  eval(['!cp ' cell2str(colormap_list,' ') ' ' fullfile(dist_path,'utils')]);
  
  %set permissions on all files to be the same
  eval(['!chmod -R 755 ' dist_path]);
  
  %tarball everything
  fprintf(1,'making tarball\n');
  eval(['!tar -C ' home_path ' -cf ' fullfile(home_path,dist_file) ' ' relative_dist_path ' --gzip']);
  
  if(DISTRIBUTE_TO_ATONAL)
    %copy the tarball to atonal
    eval(['!scp ' fullfile(home_path,dist_file) ' chromatic.cmb.ucdavis.edu:' www_path]);
  end
  
end
  
fclose(fid);
